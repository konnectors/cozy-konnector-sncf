language: node_js
node_js:
- '16.20.0'
env:
  global:
  - MATTERMOST_CHANNEL=publication
  # MATTERMOST_HOOK_URL
  - secure: UojaIKZc1DeAOOcl3oO/ECw5O5Ru91tdhPqGOT9hSIKbiWz85JtFQ3WHB6MGIVRmcUJp1UOA/u9QazezzSnSkoDrDrZdIKiI8/0t4szA1p+05Hz8Aj5XWvtPUCKqeD0TsfmUZiD1zLiZ1UOfk6UUN8k96P8zUO7mzWCRUvRPZ7YT54ZJMM4tnbH+roB404yXJfT+qpng/qsp+LnSOjLJqghjo4ClzYv9c03eW9lMH6WgKiFcBuWCKXs/QyACatFfSmDYkBgn0KBjZVQO4Um9yEAaswZ4MCc1QceWbScHlqXXw78wIAfzwlBCXgCkpGd9jzbEy5KBywefrJs7ogNeMY99L0MG/QiCfF/TEQGrDGog36scJOK4bg55Fc8d4i/4P8Wpel/7BukbVTL4ONZnV9E4MKSPonj6uEapXR5ua4/AzjWAMcZIBNyhcvJbLAKWiMObqWgzlRu7KNhC8/hNqTSxiQ3dvxgNEq9ybE3tro19yTuFTUpFEjELkeOL1ORi8Rw6JrrNprMLcENlwkDLm9MaCnu4w12DJV/BDvbR+k8W1Q4wngwkMDVNX3rusjIvpzlHz2VLQiVXxC7MZHUP6qgQvWtYtqTGaIQcIyaWJphdkd2TX/d5RD7NOAL2pJfhDnbaWpnqW1Y1tqiI/qNuPUUhGfmjDodKNGRM+h76re0=
  # REGISTRY_TOKEN slug=sncf editor=cozy space=cozy_ccc
  - secure: WzcT87Sq703v6eif8mWJQGR/4ps/i8AcrKPgoNd0UZ3W9ldVidOFlSmuOiz9PhFZwg0nlFIJt9kmyc2cX4/DC1+lxvaV749ZkmkCCgOGLQ97oZKIdJnY1wN5eXx4a988uIwEfAyIVFQUHBiGc5oBs16rmIoU3JG40hEOf4QoCpgZOo8bbzX2eeXMKpDu6Hzqpr0HO8EmZvI9585Phs8ZFkahpJPgJhXFxMc6ANyVzGLquL4B90Z2E5HHUr8MAA4xhqbhx4btJ4mxVDKx6v/WdExjXkZ0I+74ZWB+DTwWBk07rLkeKLEmWNXP9h4HkS7EKQJwWKIFINcy5FUWErUaur7qc1vVmGNrtrO/MForTZIAuMm3xdTV69wDyRlyYarupY9XJkvFl9Ur20OWJ/C2hq13KZQ4mtuV5XoyDAEmtV8oyiZRJSebpxKAcDVes5Ct8kRZTp5mFRx23UN2YKmZ1C+Uu3zi+z2kij/AMniyMrgIGIdwTP+HbZGLZvJ28FSegnSNshKceqnzvXEgZcLsc2yqGpZE+V0NgHaLtgpEnLiXpLasc9uCpxH1hTjHv4bhj8Soi53eMYoIgp3OP6Lkg2gHWvxHH2B2Ry87dJ6ripZnCvXv+ZxGjkLLAUwYB2vcwkJXY0jw3YW9CEqfhKIL6lGFDp3WthWdBsWrtHhjbbI=
cache:
  yarn: true
  directories:
  - node_modules
branches:
  except:
  - build
  - build-debug
script:
- yarn lint
- yarn build
deploy:
- provider: script
  skip-cleanup: true
  script: DEPLOY_BRANCH=build yarn deploy && yarn cozyPublish --space cozy_ccc
  on:
    branch:
    - master
    - main
- provider: script
  skip-cleanup: true
  script: DEPLOY_BRANCH=build yarn deploy && yarn cozyPublish --postpublish mattermost --space cozy_ccc
  on:
    tags: true
before_install:
- openssl aes-256-cbc -K $encrypted_8ebb1ef83f64_key -iv $encrypted_8ebb1ef83f64_iv
  -in github_deploy_key.enc -out /tmp/github_deploy_key -d
- eval "$(ssh-agent -s)"
- if [[ -f /tmp/github_deploy_key ]]; then chmod 600 /tmp/github_deploy_key; fi
- if [[ -f /tmp/github_deploy_key ]]; then ssh-add /tmp/github_deploy_key; fi
after_deploy:
- rm -f /tmp/github_deploy_key
- ssh-add -D
